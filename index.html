<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Interactive Product Visualizer (Optimized)</title>
    <style>
      body {
        margin: 0;
        overflow: hidden; /* Prevent scrollbars */
        background-color: #ffffff; /* Default white */
        color: #000000;
        font-family: sans-serif;
        touch-action: none; /* 모바일 터치 동작 최적화 */
      }
      canvas {
        display: block;
        width: 100%;
        height: 100%;
      }
      #loader {
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        font-size: 1.2em;
        color: #555;
        z-index: 101; /* Ensure loader is above canvas */
      }
      #controls {
        position: absolute;
        top: 15px;
        left: 15px;
        z-index: 100;
        background-color: rgba(30, 30, 30, 0.75);
        color: #ffffff;
        padding: 15px;
        border-radius: 8px;
        border: 1px solid rgba(255, 255, 255, 0.2);
        box-shadow: 0 4px 15px rgba(0, 0, 0, 0.3);
        max-height: 85vh;
        overflow-y: auto;
        max-width: 90%;
        box-sizing: border-box;
        touch-action: auto;
        font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
        transition: background-color 0.3s ease, color 0.3s ease,
          border-color 0.3s ease;
      }
      @media (min-width: 600px) {
        #controls {
          max-width: 280px;
        }
      }
      @media (max-width: 768px) {
        #controls {
          padding: 10px;
          font-size: 14px;
          top: 10px;
          left: 10px;
        }
        #logoImage {
          height: 30px;
          margin-bottom: 15px;
        }
        #bgColorPicker {
          width: 40px;
          height: 20px;
        }
        #visitSiteButton {
          padding: 8px;
          font-size: 0.9em;
        }
      }
      #logoImage {
        display: block;
        height: 40px;
        width: auto;
        margin-bottom: 20px;
      }
      #controls label {
        margin-bottom: 8px;
        display: block;
        font-weight: 600;
        font-size: 0.9em;
      }
      #controls h4 {
        margin: 0 0 10px 0;
        font-size: 1.1em;
        font-weight: 600;
      }
      #bgColorPicker {
        vertical-align: middle;
        cursor: pointer;
        border: 1px solid rgba(128, 128, 128, 0.5);
        width: 50px;
        height: 25px;
        margin-left: 5px;
        border-radius: 4px;
      }
      #selectedItemPanel {
        margin-top: 15px;
        padding-top: 15px;
        border-top: 1px solid rgba(128, 128, 128, 0.5);
        display: none;
      }
      #selectedItemImage {
        max-width: 100%;
        height: auto;
        margin-bottom: 10px;
        border: 1px solid rgba(255, 255, 255, 0.1);
        border-radius: 4px;
      }
      #visitSiteButton {
        display: block;
        width: 100%;
        padding: 10px 12px;
        margin-top: 10px;
        background: linear-gradient(45deg, #007bff, #0056b3);
        color: white;
        border: none;
        border-radius: 5px;
        cursor: pointer;
        text-align: center;
        font-size: 0.95em;
        font-weight: 600;
        transition: background 0.3s ease, transform 0.1s ease;
        box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);
      }
      #visitSiteButton:hover {
        background: linear-gradient(45deg, #0069d9, #004ca0);
        transform: translateY(-1px);
      }
      #visitSiteButton:disabled {
        background: #555;
        color: #aaa;
        cursor: not-allowed;
        transform: none;
        box-shadow: none;
      }
    </style>
  </head>
  <body>
    <div id="controls">
      <img
        id="logoImage"
        src="https://i.imgur.com/fgJ3rAV.png"
        alt="May I 2D Logo"
      />

      <div>
        <label for="bgColorPicker">Background Color:</label>
        <input type="color" id="bgColorPicker" value="#000000" />
      </div>

      <div id="selectedItemPanel">
        <h4>Selected Product</h4>
        <img id="selectedItemImage" src="" alt="Selected product image" />
        <button id="visitSiteButton" data-url="">Visit Site</button>
      </div>
    </div>
    <div id="loader">로딩 중... 0%</div>
    <script type="importmap">
      {
        "imports": {
          "three": "https://unpkg.com/three@0.163.0/build/three.module.js",
          "three/addons/": "https://unpkg.com/three@0.163.0/examples/jsm/"
        }
      }
    </script>
    <script type="module">
      import * as THREE from "three";
      import { OrbitControls } from "three/addons/controls/OrbitControls.js";

      // --- Configuration Constants ---
      const CONFIG = {
        IMAGE_OBJECT_COUNT: 200,
        SPREAD_RANGE: 60,
        DEFAULT_BG_COLOR: "#000000",
        HOVER_SCALE_FACTOR: 1.2,
        CLICK_PLANE_SCALE: 1.5,
        CAMERA: {
          MOBILE: { Z: 50, MIN_DISTANCE: 10, MAX_DISTANCE: 120 },
          DESKTOP: { Z: 40, MIN_DISTANCE: 5, MAX_DISTANCE: 100 },
        },
        LIGHT: {
          AMBIENT: { COLOR: 0x808080, INTENSITY: 1.8 },
          POINT: {
            COLORS: [0xffaa00, 0x00aaff, 0xff00ff, 0xaaffaa],
            INTENSITY: 2.5,
            DISTANCE: 100,
            DECAY: 1.5,
          },
        },
        ANIMATION: {
          THROTTLE: 16, // ~60fps for pointermove throttle
          ROTATION_SPEED: 0.01,
        },
      };

      // --- Product Data ---
      const products = [
        {
          imageUrl: "https://i.imgur.com/px60C11.png",
          purchaseUrl: "https://mayi2d.shop/products/rose-little-prince",
        },
        {
          imageUrl: "https://i.imgur.com/eqcLGF6.png",
          purchaseUrl: "https://mayi2d.shop/products/amen%F0%9F%99%8F",
        },
        {
          imageUrl: "https://i.imgur.com/xU7TS58.png",
          purchaseUrl: "https://mayi2d.shop/products/sweet-panda",
        },
        {
          imageUrl: "https://i.imgur.com/5b9EsGB.png",
          purchaseUrl: "https://mayi2d.shop/products/black-punk-skull",
        },
        {
          imageUrl: "https://i.imgur.com/bPXsjAw.png",
          purchaseUrl: "https://mayi2d.shop/products/money-shape",
        },
        {
          imageUrl: "https://i.imgur.com/GETdAiE.png",
          purchaseUrl: "https://mayi2d.shop/products/bread-series",
        },
        {
          imageUrl: "https://i.imgur.com/Yz7dBh7.png",
          purchaseUrl:
            "https://mayi2d.shop/products/dinosaur-nugget-and-ketchup",
        },
        {
          imageUrl: "https://i.imgur.com/1LF0lQF.png",
          purchaseUrl: "https://mayi2d.shop/products/lab-mouse",
        },
        {
          imageUrl: "https://i.imgur.com/HNLaeRM.png",
          purchaseUrl: "https://mayi2d.shop/products/lab-flask-plants",
        },
        {
          imageUrl: "https://i.imgur.com/xi6EnkF.png",
          purchaseUrl: "https://mayi2d.shop/products/alien-green-cat-ufo",
        },
        {
          imageUrl: "https://i.imgur.com/sllSsvG.png",
          purchaseUrl: "https://mayi2d.shop/products/im-rock",
        },
        {
          imageUrl: "https://i.imgur.com/gA6lWEj.png",
          purchaseUrl:
            "https://mayi2d.shop/products/soooo-cute-dinosaur-%F0%9F%91%BE",
        },
        {
          imageUrl: "https://i.imgur.com/lRt2Uqw.png",
          purchaseUrl: "http://mayi2d.shop/products/beetles",
        },
        {
          imageUrl: "https://i.imgur.com/gAhjsnt.png",
          purchaseUrl: "https://mayi2d.shop/products/one-eyed-mon",
        },
        {
          imageUrl: "https://i.imgur.com/m7fDSk8.png",
          purchaseUrl:
            "https://mayi2d.shop/products/radioactive-radiation-labeling",
        },
        {
          imageUrl: "https://i.imgur.com/lqjsDYn.png",
          purchaseUrl:
            "https://mayi2d.shop/products/marine-creatures%F0%9F%90%9A",
        },
        {
          imageUrl: "https://i.imgur.com/sHcbpIm.png",
          purchaseUrl: "https://mayi2d.shop/products/black-white-day",
        },
        {
          imageUrl: "https://i.imgur.com/HIh73o1.png",
          purchaseUrl: "https://mayi2d.shop/products/lazying-cat",
        },
        {
          imageUrl: "https://i.imgur.com/wLvfLgH.png",
          purchaseUrl: "https://mayi2d.shop/products/fluffy-penguin-lettering",
        },
        {
          imageUrl: "https://i.imgur.com/mSUxi9J.png",
          purchaseUrl: "https://mayi2d.shop/products/gas-mask",
        },
        {
          imageUrl: "https://i.imgur.com/Cg1z4B7.png",
          purchaseUrl: "https://mayi2d.shop/products/green-frog-on-stool",
        },
        {
          imageUrl: "https://i.imgur.com/N5XMO80.png",
          purchaseUrl: "https://mayi2d.shop/products/fire-helllmo",
        },
        {
          imageUrl: "https://i.imgur.com/p8SCKt6.png",
          purchaseUrl: "https://mayi2d.shop/products/honk-honk",
        },
        {
          imageUrl: "https://i.imgur.com/k7lFI9V.png",
          purchaseUrl: "https://mayi2d.shop/products/punk-skull",
        },
        {
          imageUrl: "https://i.imgur.com/GKfk2sx.png",
          purchaseUrl: "https://mayi2d.shop/products/shotguns",
        },
        {
          imageUrl: "https://i.imgur.com/YFUaw45.png",
          purchaseUrl: "https://mayi2d.shop/products/wings-eye",
        },
        {
          imageUrl: "https://i.imgur.com/W7kVc9D.png",
          purchaseUrl: "https://mayi2d.shop/products/magic-potion",
        },
        {
          imageUrl: "https://i.imgur.com/ohX7Kk0.png",
          purchaseUrl: "https://mayi2d.shop/products/pool-boby",
        },
        {
          imageUrl: "https://i.imgur.com/9GLdv8S.png",
          purchaseUrl: "https://mayi2d.shop/products/mystery-stuff",
        },
        {
          imageUrl: "https://i.imgur.com/mywFTuJ.png",
          purchaseUrl: "https://mayi2d.shop/products/luna-eye",
        },
        {
          imageUrl: "https://i.imgur.com/u0Zax2J.png",
          purchaseUrl: "https://mayi2d.shop/products/triple-bus",
        },
        {
          imageUrl: "https://i.imgur.com/LZK48F5.png",
          purchaseUrl: "https://mayi2d.shop/products/space-company",
        },
        {
          imageUrl: "https://i.imgur.com/7pJLecy.png",
          purchaseUrl: "https://mayi2d.shop/products/pumpkin-friends",
        },
        {
          imageUrl: "https://i.imgur.com/hgr5Fgw.png",
          purchaseUrl: "https://mayi2d.shop/products/i-did-it",
        },
        {
          imageUrl: "https://i.imgur.com/tY2g0wr.png",
          purchaseUrl: "https://mayi2d.shop/products/romance-pin",
        },
        {
          imageUrl: "https://i.imgur.com/ZnKfEt1.png",
          purchaseUrl: "https://mayi2d.shop/products/coffee-pumpkin",
        },
        {
          imageUrl: "https://i.imgur.com/5g5pJBb.png",
          purchaseUrl: "https://mayi2d.shop/products/pink-slime",
        },
        {
          imageUrl: "https://i.imgur.com/nwUPDLq.png",
          purchaseUrl: "https://mayi2d.shop/products/ticket",
        },
        {
          imageUrl: "https://i.imgur.com/l1Enik5.png",
          purchaseUrl: "https://mayi2d.shop/products/insam",
        },
        {
          imageUrl: "https://i.imgur.com/0cr9Tpx.png",
          purchaseUrl: "https://mayi2d.shop/products/science-brooches",
        },
        {
          imageUrl: "https://i.imgur.com/Gn8rTId.png",
          purchaseUrl: "https://mayi2d.shop/products/sports-star-uniform",
        },
        {
          imageUrl: "https://i.imgur.com/IeORQvd.png",
          purchaseUrl: "https://mayi2d.shop/products/startled-cat",
        },
        {
          imageUrl: "https://i.imgur.com/lAa6rbg.png",
          purchaseUrl: "https://mayi2d.shop/products/meow-cat-keychain-luck-1",
        },
        {
          imageUrl: "https://i.imgur.com/7votial.png",
          purchaseUrl: "https://mayi2d.shop/products/sad-hamster-key-chain",
        },
        {
          imageUrl: "https://i.imgur.com/INNoWiQ.png",
          purchaseUrl: "https://mayi2d.shop/products/stronger-than-you-think",
        },
        {
          imageUrl: "https://i.imgur.com/HYDjwO6.png",
          purchaseUrl: "https://mayi2d.shop/products/movie-car",
        },
        {
          imageUrl: "https://i.imgur.com/kQ6YI7e.png",
          purchaseUrl: "https://mayi2d.shop/products/punk-skull-symbol",
        },
        {
          imageUrl: "https://i.imgur.com/KoAL6XJ.png",
          purchaseUrl: "https://mayi2d.shop/products/punisher-skull",
        },
        {
          imageUrl: "https://i.imgur.com/wTFSY5N.png",
          purchaseUrl: "https://mayi2d.shop/products/skull-of-rock",
        },
        {
          imageUrl: "https://i.imgur.com/tXsQz9f.png",
          purchaseUrl: "https://mayi2d.shop/products/gold-47",
        },
        {
          imageUrl: "https://i.imgur.com/Jkb1XgY.png",
          purchaseUrl: "https://mayi2d.shop/products/glock-z",
        },
        {
          imageUrl: "https://i.imgur.com/DRpZAg2.png",
          purchaseUrl: "https://mayi2d.shop/products/just-life",
        },
        {
          imageUrl: "https://i.imgur.com/QcUVzYZ.png",
          purchaseUrl: "https://mayi2d.shop/products/green-plant-animal-face",
        },
        {
          imageUrl: "https://i.imgur.com/Duz6x1z.png",
          purchaseUrl: "https://mayi2d.shop/products/vegetarian-bottle",
        },
        {
          imageUrl: "https://i.imgur.com/n2y5M5O.png",
          purchaseUrl: "https://mayi2d.shop/products/pink-joint",
        },
        {
          imageUrl: "https://i.imgur.com/kErgX0i.png",
          purchaseUrl: "https://mayi2d.shop/products/1-minute-later",
        },
        {
          imageUrl: "https://i.imgur.com/jnQKuCP.png",
          purchaseUrl: "https://mayi2d.shop/products/coral-reef-j",
        },
        {
          imageUrl: "https://i.imgur.com/K25eeaD.png",
          purchaseUrl: "https://mayi2d.shop/products/daisy-bong",
        },
        {
          imageUrl: "https://i.imgur.com/r8ECoPz.png",
          purchaseUrl: "https://mayi2d.shop/products/hungry-larva",
        },
        {
          imageUrl: "https://i.imgur.com/9UeUROm.png",
          purchaseUrl: "https://mayi2d.shop/products/sunday-cupcake",
        },
        {
          imageUrl: "https://i.imgur.com/OzerZT3.png",
          purchaseUrl: "https://mayi2d.shop/products/human-organ-bottle",
        },
        {
          imageUrl: "https://i.imgur.com/Ru0Xgz7.png",
          purchaseUrl: "https://mayi2d.shop/products/need-more-coffee",
        },
        {
          imageUrl: "https://i.imgur.com/p52R6HC.png",
          purchaseUrl: "https://mayi2d.shop/products/pink-portal",
        },
        {
          imageUrl: "https://i.imgur.com/h0oqrIs.png",
          purchaseUrl: "https://mayi2d.shop/products/girl-power%F0%9F%8C%9F",
        },
        {
          imageUrl: "https://i.imgur.com/BJkmLGm.png",
          purchaseUrl: "https://mayi2d.shop/products/colored-painting-brush",
        },
        {
          imageUrl: "https://i.imgur.com/2xwHP9f.png",
          purchaseUrl: "https://mayi2d.shop/products/women-belong-in-the-lab",
        },
        {
          imageUrl: "https://i.imgur.com/i4erGhU.png",
          purchaseUrl: "https://mayi2d.shop/products/feeling-goods-good-enough",
        },
        {
          imageUrl: "https://i.imgur.com/Zx4kwTX.png",
          purchaseUrl: "https://mayi2d.shop/products/you-are-the-dancing-queen",
        },
        {
          imageUrl: "https://i.imgur.com/oAKjGrr.png",
          purchaseUrl: "https://mayi2d.shop/products/angel-love",
        },
        {
          imageUrl: "https://i.imgur.com/gC2kQjV.png",
          purchaseUrl: "https://mayi2d.shop/products/burning-dice-%F0%9F%94%A5",
        },
        {
          imageUrl: "https://i.imgur.com/idF7VmU.png",
          purchaseUrl:
            "https://mayi2d.shop/products/strawberries-basket-%F0%9F%8D%93",
        },
        {
          imageUrl: "https://i.imgur.com/9LOM18S.png",
          purchaseUrl: "https://mayi2d.shop/products/cheeze-alien-%F0%9F%91%BD",
        },
        {
          imageUrl: "https://i.imgur.com/kPXg6nF.png",
          purchaseUrl: "https://mayi2d.shop/products/wtf",
        },
        {
          imageUrl: "https://i.imgur.com/Lui16w2.png",
          purchaseUrl: "https://mayi2d.shop/products/the-future-is-bright",
        },
        {
          imageUrl: "https://i.imgur.com/NISHMQM.png",
          purchaseUrl: "https://mayi2d.shop/products/purple-room",
        },
        {
          imageUrl: "https://i.imgur.com/RFgtNCw.png",
          purchaseUrl: "https://mayi2d.shop/products/legend-punk",
        },
        {
          imageUrl: "https://i.imgur.com/AQKHdX4.png",
          purchaseUrl:
            "https://mayi2d.shop/products/i-tolerate-many-things-but-i-cant-tolerate-bran",
        },
        {
          imageUrl: "https://i.imgur.com/lCDwzqg.png",
          purchaseUrl: "https://mayi2d.shop/products/dear-me",
        },
        {
          imageUrl: "https://i.imgur.com/A2bDvb5.png",
          purchaseUrl: "https://mayi2d.shop/products/cow-duck",
        },
        {
          imageUrl: "https://i.imgur.com/vUs3ezp.png",
          purchaseUrl: "https://mayi2d.shop/products/red-oni",
        },
        {
          imageUrl: "https://i.imgur.com/fXbc49J.png",
          purchaseUrl: "https://mayi2d.shop/products/skeleton-cat-disco",
        },
        {
          imageUrl: "https://i.imgur.com/hqZTWIb.png",
          purchaseUrl: "https://mayi2d.shop/products/im-doing-side-quests",
        },
        {
          imageUrl: "https://i.imgur.com/6PL3QQU.png",
          purchaseUrl: "https://mayi2d.shop/products/la-blue-ice",
        },
        {
          imageUrl: "https://i.imgur.com/y0PKlj4.png",
          purchaseUrl: "https://mayi2d.shop/products/wah",
        },
        {
          imageUrl: "https://i.imgur.com/bVGIDwp.png",
          purchaseUrl: "https://mayi2d.shop/products/see-house",
        },
        {
          imageUrl: "https://i.imgur.com/ECUPs7R.png",
          purchaseUrl: "https://mayi2d.shop/products/warrior-pin",
        },
        {
          imageUrl: "https://i.imgur.com/Wh4lBna.png",
          purchaseUrl: "https://mayi2d.shop/products/its-just-a-flesh-wound",
        },
        {
          imageUrl: "https://i.imgur.com/ScKhQ3y.png",
          purchaseUrl: "https://mayi2d.shop/products/cat-with-knife",
        },
        {
          imageUrl: "https://i.imgur.com/prXigEi.png",
          purchaseUrl:
            "https://mayi2d.shop/products/lucky-swords-%F0%9F%97%A1%EF%B8%8F",
        },
        {
          imageUrl: "https://i.imgur.com/Ab6SXOT.png",
          purchaseUrl: "https://mayi2d.shop/products/ranger-mask",
        },
        {
          imageUrl: "https://i.imgur.com/L8sqXwg.png",
          purchaseUrl: "https://mayi2d.shop/products/pink-mouse",
        },
        {
          imageUrl: "https://i.imgur.com/uTE8O4b.png",
          purchaseUrl: "https://mayi2d.shop/products/dr-peepee",
        },
        {
          imageUrl: "https://i.imgur.com/erHLzLb.png",
          purchaseUrl: "https://mayi2d.shop/products/seraph-cat-wings",
        },
        {
          imageUrl: "https://i.imgur.com/rvCx8ym.png",
          purchaseUrl: "https://mayi2d.shop/products/nugs-not-drugs",
        },
        {
          imageUrl: "https://i.imgur.com/rC6BEDK.png",
          purchaseUrl: "https://mayi2d.shop/products/boy-money",
        },
        {
          imageUrl: "https://i.imgur.com/MswTpby.png",
          purchaseUrl: "https://mayi2d.shop/products/pink-pistol",
        },
        {
          imageUrl: "https://i.imgur.com/PrGSHhP.png",
          purchaseUrl: "https://mayi2d.shop/products/goose-goose-drive",
        },
        {
          imageUrl: "https://i.imgur.com/SZyg85x.png",
          purchaseUrl: "https://mayi2d.shop/products/our-rainy-night-together",
        },
        {
          imageUrl: "https://i.imgur.com/Vf1l8lS.png",
          purchaseUrl: "https://mayi2d.shop/products/dance-frog",
        },
        {
          imageUrl: "https://i.imgur.com/vJrzH8u.png",
          purchaseUrl: "https://mayi2d.shop/products/really",
        },
        {
          imageUrl: "https://i.imgur.com/LXVPdzZ.png",
          purchaseUrl: "https://mayi2d.shop/products/fibonacci",
        },
        {
          imageUrl: "https://i.imgur.com/Lmq94tj.png",
          purchaseUrl:
            "https://mayi2d.shop/products/something-that-makes-you-zone-out",
        },
        {
          imageUrl: "https://i.imgur.com/pDdxXoB.png",
          purchaseUrl: "https://mayi2d.shop/products/as-it-sways",
        },
        {
          imageUrl: "https://i.imgur.com/jyMoju7.png",
          purchaseUrl: "https://mayi2d.shop/products/wiggly-jellyfish",
        },
        {
          imageUrl: "https://i.imgur.com/Rlqrs0r.png",
          purchaseUrl: "https://mayi2d.shop/products/believe-me-im-not-a-ghost",
        },
        {
          imageUrl: "https://i.imgur.com/AJFTPXF.png",
          purchaseUrl:
            "https://mayi2d.shop/products/teetering-between-despair-and-darkness",
        },
        {
          imageUrl: "https://i.imgur.com/yS0fYU6.png",
          purchaseUrl:
            "https://mayi2d.shop/products/an-elephant-with-octopus-tentacles",
        },
        {
          imageUrl: "https://i.imgur.com/xJMg5zj.png",
          purchaseUrl: "https://mayi2d.shop/products/two-birds",
        },
        {
          imageUrl: "https://i.imgur.com/e4MBcKm.png",
          purchaseUrl: "https://mayi2d.shop/products/blue-bird",
        },
        {
          imageUrl: "https://i.imgur.com/7gHToMe.png",
          purchaseUrl: "https://mayi2d.shop/products/mushroom-enamel-pin",
        },
        {
          imageUrl: "https://i.imgur.com/GbgorJV.png",
          purchaseUrl:
            "https://mayi2d.shop/products/inspiration-old-pawn-indian-fred-bird",
        },
        {
          imageUrl: "https://i.imgur.com/XmtTrNd.png",
          purchaseUrl: "https://mayi2d.shop/products/with-hands-joined",
        },
        {
          imageUrl: "https://i.imgur.com/SZyvd09.png",
          purchaseUrl: "https://mayi2d.shop/products/neuron-potential",
        },
        {
          imageUrl: "https://i.imgur.com/chrFVib.png",
          purchaseUrl: "https://mayi2d.shop/products/peaceful-clouds",
        },
        {
          imageUrl: "https://i.imgur.com/pukx8C1.png",
          purchaseUrl: "https://mayi2d.shop/products/black-love",
        },
        {
          imageUrl: "https://i.imgur.com/rkb5zVw.png",
          purchaseUrl:
            "https://mayi2d.shop/products/surprisingly-its-not-an-ancient-artifact-just-a-book-that-looks-like-one",
        },
        {
          imageUrl: "https://i.imgur.com/NKirQGP.png",
          purchaseUrl: "https://mayi2d.shop/products/round-muzzle",
        },
        {
          imageUrl: "https://i.imgur.com/VDwCUKT.png",
          purchaseUrl: "https://mayi2d.shop/products/eagerly-hand",
        },
        {
          imageUrl: "https://i.imgur.com/keoxIUK.png",
          purchaseUrl: "https://mayi2d.shop/products/hippie-bus",
        },
        {
          imageUrl: "https://i.imgur.com/7ii0Pe2.png",
          purchaseUrl: "https://mayi2d.shop/products/elephant-boho",
        },
        {
          imageUrl: "https://i.imgur.com/JcUnlYc.png",
          purchaseUrl: "https://mayi2d.shop/products/smile-lsd",
        },
        {
          imageUrl: "https://i.imgur.com/jHj47lu.png",
          purchaseUrl: "https://mayi2d.shop/products/the-astronaut",
        },
        {
          imageUrl: "https://i.imgur.com/nr82kuE.png",
          purchaseUrl: "https://mayi2d.shop/products/ninja-chakra",
        },
        {
          imageUrl: "https://i.imgur.com/q8I54Z4.png",
          purchaseUrl:
            "https://mayi2d.shop/products/my-anxieties-have-anxieties",
        },
        {
          imageUrl: "https://i.imgur.com/mEOKviv.png",
          purchaseUrl: "https://mayi2d.shop/products/gotham-city",
        },
        {
          imageUrl: "https://i.imgur.com/Q9kLNeZ.png",
          purchaseUrl: "https://mayi2d.shop/products/fire-demon-set",
        },
        {
          imageUrl: "https://i.imgur.com/F5o1tKT.png",
          purchaseUrl: "https://mayi2d.shop/products/lovely-cats",
        },
        {
          imageUrl: "https://i.imgur.com/S95fvPl.png",
          purchaseUrl: "https://mayi2d.shop/products/lab-mouse-1",
        },
        {
          imageUrl: "https://i.imgur.com/t0yrawI.png",
          purchaseUrl: "https://mayi2d.shop/products/angry-red-rabbit",
        },
        {
          imageUrl: "https://i.imgur.com/k5hTHgQ.png",
          purchaseUrl: "https://mayi2d.shop/products/money-shape-1",
        },
        {
          imageUrl: "https://i.imgur.com/E3EEICL.png",
          purchaseUrl: "https://mayi2d.shop/products/rstar",
        },
        {
          imageUrl: "https://i.imgur.com/9NPdoEy.png",
          purchaseUrl: "https://mayi2d.shop/products/btc",
        },
        {
          imageUrl: "https://i.imgur.com/1jPRCDP.png",
          purchaseUrl: "https://mayi2d.shop/products/skull-candy",
        },
        {
          imageUrl: "https://i.imgur.com/vzUt3ke.jpeg",
          purchaseUrl: "https://mayi2d.shop/products/i-tried",
        },
        {
          imageUrl: "https://i.imgur.com/AsePceB.png",
          purchaseUrl: "https://mayi2d.shop/products/cat-card",
        },
        {
          imageUrl: "https://i.imgur.com/FjDKimK.png",
          purchaseUrl: "https://mayi2d.shop/products/this-is-fine",
        },
        {
          imageUrl: "https://i.imgur.com/9eEg1rP.png",
          purchaseUrl: "https://mayi2d.shop/products/metal-chariot",
        },
        {
          imageUrl: "https://i.imgur.com/N16f6kc.png",
          purchaseUrl: "https://mayi2d.shop/products/2050-knightmare",
        },
        {
          imageUrl: "https://i.imgur.com/9YAm1Ms.png",
          purchaseUrl: "https://mayi2d.shop/products/let-it-burn",
        },
        {
          imageUrl: "https://i.imgur.com/EFSH1Lz.png",
          purchaseUrl: "https://mayi2d.shop/products/1am-ramen",
        },
        {
          imageUrl: "https://i.imgur.com/zbw1jyf.png",
          purchaseUrl: "https://mayi2d.shop/products/dinosaur-bongbong",
        },
        {
          imageUrl: "https://i.imgur.com/4iDj0kV.png",
          purchaseUrl: "https://mayi2d.shop/products/%E2%9C%9D%EF%B8%8F",
        },
        {
          imageUrl: "https://i.imgur.com/QWFdy2r.png",
          purchaseUrl: "https://mayi2d.shop/products/jesus-band",
        },
        {
          imageUrl: "https://i.imgur.com/0zfAn9S.png",
          purchaseUrl: "https://mayi2d.shop/products/cute-chameleon",
        },
        {
          imageUrl: "https://i.imgur.com/rPofAT4.png",
          purchaseUrl: "https://mayi2d.shop/products/pathetically-sad-cat",
        },
        {
          imageUrl: "https://i.imgur.com/fOOL18m.png",
          purchaseUrl: "https://mayi2d.shop/products/emblem-of-divinity",
        },
        {
          imageUrl: "https://i.imgur.com/FAsrboW.png",
          purchaseUrl: "https://mayi2d.shop/products/the-fluid-forest-tracker",
        },
        {
          imageUrl: "https://i.imgur.com/0LSeR4p.png",
          purchaseUrl: "https://mayi2d.shop/products/floral-cutie-alien",
        },
        {
          imageUrl: "https://i.imgur.com/RP9RFbQ.png",
          purchaseUrl: "https://mayi2d.shop/products/super-smash-bros",
        },
        {
          imageUrl: "https://i.imgur.com/5AdYmGl.png",
          purchaseUrl: "https://mayi2d.shop/products/sweet-duck",
        },
        {
          imageUrl: "https://i.imgur.com/GMKwIQe.png",
          purchaseUrl: "https://mayi2d.shop/products/re-1",
        },
        {
          imageUrl: "https://i.imgur.com/kYitjLJ.png",
          purchaseUrl: "https://mayi2d.shop/products/3d-game",
        },
        {
          imageUrl: "https://i.imgur.com/B9rHIAF.png",
          purchaseUrl: "https://mayi2d.shop/products/silly-juice",
        },
        {
          imageUrl: "https://i.imgur.com/oXCvczU.png",
          purchaseUrl:
            "https://mayi2d.shop/products/came-across-some-green-crocs",
        },
        {
          imageUrl: "https://i.imgur.com/hLI1zgx.png",
          purchaseUrl: "https://mayi2d.shop/products/white-warrior",
        },
        {
          imageUrl: "https://i.imgur.com/J13vxdy.png",
          purchaseUrl: "https://mayi2d.shop/products/animal-pin",
        },
        // Example products pointing to base shop URL
        {
          imageUrl: "https://i.imgur.com/mtnb81v.png",
          purchaseUrl: "https://mayi2d.shop/",
        },
        {
          imageUrl: "https://i.imgur.com/Xsa2DmF.png",
          purchaseUrl: "https://mayi2d.shop/",
        },
        {
          imageUrl: "https://i.imgur.com/mvn1RRw.png",
          purchaseUrl: "https://mayi2d.shop/",
        },
        {
          imageUrl: "https://i.imgur.com/UYyZi89.png",
          purchaseUrl: "https://mayi2d.shop/",
        },
        {
          imageUrl: "https://i.imgur.com/Tu7B9t4.png",
          purchaseUrl: "https://mayi2d.shop/",
        },
        {
          imageUrl: "https://i.imgur.com/rYZxLEl.png",
          purchaseUrl: "https://mayi2d.shop/",
        },
        {
          imageUrl: "https://i.imgur.com/pmYZnAD.png",
          purchaseUrl: "https://mayi2d.shop/",
        },
        {
          imageUrl: "https://i.imgur.com/zEWGkkm.png",
          purchaseUrl: "https://mayi2d.shop/",
        },
        {
          imageUrl: "https://i.imgur.com/AtIkq6X.png",
          purchaseUrl: "https://mayi2d.shop/",
        },
        {
          imageUrl: "https://i.imgur.com/RxVUfe0.png",
          purchaseUrl: "https://mayi2d.shop/",
        },
      ];

      // --- State Management ---
      let scene, camera, renderer, controls;
      const instancedMeshes = []; // Array to hold multiple InstancedMesh objects
      const raycastMeshes = []; // Array to hold transparent InstancedMesh objects
      const instanceData = []; // Holds data for all 200 conceptual instances
      const pointLights = [];
      const raycaster = new THREE.Raycaster();
      const pointer = new THREE.Vector2();
      let INTERSECTED_INFO = null; // { originalIndex, meshGroup, localInstanceId }
      const clock = new THREE.Clock();
      const textureCache = new Map();
      let sharedPlaneGeometry; // Single geometry instance
      let sharedRaycastGeometry; // Single geometry instance for transparent mesh
      let sharedRaycastMaterial; // Single material instance for transparent mesh
      let texturesLoaded = 0; // Track number of textures loaded
      let totalTexturesToLoad = 0; // Total number of textures to load

      let particleSystem; // Particle system for visual effects

      // 호버 효과용 색상 변수
      const hoverColor = new THREE.Color(1, 1, 0.6); // 호버 시 적용할 색상 (약간 노란빛 도는 흰색)
      const normalColor = new THREE.Color(1, 1, 1); // 기본 색상 (흰색)

      // --- DOM Elements ---
      const bgColorPicker = document.getElementById("bgColorPicker");
      const controlsElement = document.getElementById("controls");
      const selectedItemPanel = document.getElementById("selectedItemPanel");
      const selectedItemImage = document.getElementById("selectedItemImage");
      const visitSiteButton = document.getElementById("visitSiteButton");
      const loaderElement = document.getElementById("loader");
      const logoImageElement = document.getElementById("logoImage");

      // --- Temporary Objects (Prevent GC) ---
      const tempMatrix = new THREE.Matrix4();
      const tempObject = new THREE.Object3D(); // Used for matrix composition
      const tempPosition = new THREE.Vector3();
      const tempQuaternion = new THREE.Quaternion();
      const tempScale = new THREE.Vector3(1, 1, 1);
      const hoverScaleVec = new THREE.Vector3(
        CONFIG.HOVER_SCALE_FACTOR,
        CONFIG.HOVER_SCALE_FACTOR,
        CONFIG.HOVER_SCALE_FACTOR
      );
      const normalScaleVec = new THREE.Vector3(1, 1, 1);

      // --- Initialization ---
      init();
      animate();

      async function init() {
        try {
          // 로고 이미지 URL 변경
          if (logoImageElement) {
            logoImageElement.src = "https://i.imgur.com/fgJ3rAV.png";
          }

          // Scene Setup
          scene = new THREE.Scene();
          scene.fog = new THREE.FogExp2(
            new THREE.Color(CONFIG.DEFAULT_BG_COLOR).getHex(),
            0.01
          );

          // Device Detection
          const isMobile = /iPhone|iPad|iPod|Android/i.test(
            navigator.userAgent
          );

          // Camera Setup
          camera = new THREE.PerspectiveCamera(
            75,
            window.innerWidth / window.innerHeight,
            0.1,
            1000
          );
          camera.position.z = isMobile
            ? CONFIG.CAMERA.MOBILE.Z
            : CONFIG.CAMERA.DESKTOP.Z;

          // Renderer Setup
          renderer = new THREE.WebGLRenderer({
            antialias: true,
            powerPreference: "high-performance",
          });
          renderer.setSize(window.innerWidth, window.innerHeight);
          renderer.setPixelRatio(Math.min(window.devicePixelRatio, 2));
          renderer.setClearColor(
            new THREE.Color(CONFIG.DEFAULT_BG_COLOR).getHex()
          );
          document.body.appendChild(renderer.domElement);

          // Controls Setup
          controls = new OrbitControls(camera, renderer.domElement);
          controls.enableDamping = true;
          controls.dampingFactor = 0.05;
          controls.screenSpacePanning = false;
          controls.minDistance = isMobile
            ? CONFIG.CAMERA.MOBILE.MIN_DISTANCE
            : CONFIG.CAMERA.DESKTOP.MIN_DISTANCE;
          controls.maxDistance = isMobile
            ? CONFIG.CAMERA.MOBILE.MAX_DISTANCE
            : CONFIG.CAMERA.DESKTOP.MAX_DISTANCE;

          if (isMobile) {
            controls.enableZoom = true;
            controls.enablePan = true;
          }

          // Lighting Setup
          const ambientLight = new THREE.AmbientLight(
            CONFIG.LIGHT.AMBIENT.COLOR,
            CONFIG.LIGHT.AMBIENT.INTENSITY
          );
          scene.add(ambientLight);

          CONFIG.LIGHT.POINT.COLORS.forEach((color) => {
            const pointLight = new THREE.PointLight(
              color,
              CONFIG.LIGHT.POINT.INTENSITY,
              CONFIG.LIGHT.POINT.DISTANCE,
              CONFIG.LIGHT.POINT.DECAY
            );
            pointLight.position.set(
              (Math.random() - 0.5) * CONFIG.SPREAD_RANGE * 1.2,
              (Math.random() - 0.5) * CONFIG.SPREAD_RANGE * 1.2,
              (Math.random() - 0.5) * CONFIG.SPREAD_RANGE * 1.2
            );
            pointLight.userData = {
              angle: Math.random() * Math.PI * 2,
              radius: 10 + Math.random() * 20,
              speed:
                (Math.random() + 0.5) * 0.4 * (Math.random() > 0.5 ? 1 : -1),
              yOffset: (Math.random() - 0.5) * 15,
            };
            scene.add(pointLight);
            pointLights.push(pointLight);
          });

          // --- 파티클 시스템 생성 ---
          function createParticles() {
            const particleCount = 7000;
            const positions = new Float32Array(particleCount * 3);
            const particleSpreadRadius = 150;

            for (let i = 0; i < particleCount; i++) {
              const i3 = i * 3;
              const u = Math.random();
              const v = Math.random();
              const theta = 2 * Math.PI * u;
              const phi = Math.acos(2 * v - 1);
              const r = Math.cbrt(Math.random()) * particleSpreadRadius;

              positions[i3] = r * Math.sin(phi) * Math.cos(theta);
              positions[i3 + 1] = r * Math.sin(phi) * Math.sin(theta);
              positions[i3 + 2] = r * Math.cos(phi);
            }

            const geometry = new THREE.BufferGeometry();
            geometry.setAttribute(
              "position",
              new THREE.BufferAttribute(positions, 3)
            );

            const material = new THREE.PointsMaterial({
              color: 0xffffff,
              size: 0.1,
              sizeAttenuation: true,
              transparent: true,
              opacity: 0.75,
              depthWrite: false,
            });

            particleSystem = new THREE.Points(geometry, material);
            scene.add(particleSystem);
            console.log("파티클 시스템이 생성되었습니다.");
          }

          createParticles();

          // Create shared geometry
          sharedPlaneGeometry = new THREE.PlaneGeometry(2.5, 2.5);
          sharedRaycastGeometry = new THREE.PlaneGeometry(
            2.5 * CONFIG.CLICK_PLANE_SCALE,
            2.5 * CONFIG.CLICK_PLANE_SCALE
          );
          sharedRaycastMaterial = new THREE.MeshBasicMaterial({
            visible: false,
            side: THREE.DoubleSide,
          });

          // Load and setup instances
          await setupGroupedInstances();

          // Event Listeners
          setupEventListeners();
        } catch (error) {
          console.error("Initialization error:", error);
          showError(
            "초기화 중 오류가 발생했습니다. 페이지를 새로고침해주세요."
          );
          if (loaderElement) loaderElement.textContent = "오류 발생!";
        }
      }

      async function setupGroupedInstances() {
        const loadingManager = new THREE.LoadingManager();
        texturesLoaded = 0;
        totalTexturesToLoad = 0;

        loadingManager.onProgress = (url, loaded, total) => {
          // Progress is handled by our custom tracking
        };

        loadingManager.onLoad = () => {
          console.log("Loading manager finished.");
        };

        loadingManager.onError = (url) => {
          console.error("Error loading texture via manager:", url);
          checkLoadingComplete();
        };

        const textureLoader = new THREE.TextureLoader(loadingManager);
        textureLoader.setCrossOrigin("anonymous");

        // Group instances by texture URL
        const groupedInstances = new Map();
        for (let i = 0; i < CONFIG.IMAGE_OBJECT_COUNT; i++) {
          const productIndex = i % products.length;
          const product = products[productIndex];

          if (!product || !product.imageUrl) {
            console.warn(`Skipping instance ${i}: Missing product or imageUrl`);
            continue;
          }

          if (!groupedInstances.has(product.imageUrl)) {
            groupedInstances.set(product.imageUrl, {
              product: product,
              originalIndices: [],
            });
          }
          groupedInstances.get(product.imageUrl).originalIndices.push(i);

          instanceData[i] = {
            purchaseUrl: product.purchaseUrl,
            imageUrl: product.imageUrl,
            rotationSpeed: new THREE.Vector3(
              (Math.random() - 0.5) * CONFIG.ANIMATION.ROTATION_SPEED,
              (Math.random() - 0.5) * CONFIG.ANIMATION.ROTATION_SPEED,
              (Math.random() - 0.5) * CONFIG.ANIMATION.ROTATION_SPEED
            ),
            visibleMeshGroup: null,
            raycastMeshGroup: null,
            localInstanceId: -1,
          };
        }

        totalTexturesToLoad = groupedInstances.size;
        if (loaderElement)
          updateLoaderProgress(texturesLoaded, totalTexturesToLoad);

        const loadPromises = [];

        for (const [imageUrl, group] of groupedInstances.entries()) {
          const loadPromise = loadTexture(textureLoader, imageUrl)
            .then((texture) => {
              texturesLoaded++;
              updateLoaderProgress(texturesLoaded, totalTexturesToLoad);

              // 보이는 메쉬 그룹 생성
              const visibleMaterial = new THREE.MeshBasicMaterial({
                map: texture,
                side: THREE.DoubleSide,
                transparent: true,
                alphaTest: 0.1,
                vertexColors: false,
              });
              const visibleMeshGroup = new THREE.InstancedMesh(
                sharedPlaneGeometry,
                visibleMaterial,
                group.originalIndices.length
              );

              // 초기 색상 설정
              for (let j = 0; j < group.originalIndices.length; j++) {
                visibleMeshGroup.setColorAt(j, normalColor);
              }
              if (visibleMeshGroup.instanceColor) {
                visibleMeshGroup.instanceColor.needsUpdate = true;
              }

              visibleMeshGroup.userData.imageUrl = imageUrl;
              scene.add(visibleMeshGroup);
              instancedMeshes.push(visibleMeshGroup);

              // 클릭 감지용 메쉬 그룹 생성
              const raycastMeshGroup = new THREE.InstancedMesh(
                sharedRaycastGeometry,
                sharedRaycastMaterial,
                group.originalIndices.length
              );
              scene.add(raycastMeshGroup);
              raycastMeshes.push(raycastMeshGroup);

              group.originalIndices.forEach((originalIndex, localIndex) => {
                tempPosition.set(
                  (Math.random() - 0.5) * CONFIG.SPREAD_RANGE,
                  (Math.random() - 0.5) * CONFIG.SPREAD_RANGE,
                  (Math.random() - 0.5) * CONFIG.SPREAD_RANGE
                );

                tempQuaternion.setFromEuler(
                  new THREE.Euler(
                    Math.random() * Math.PI * 2,
                    Math.random() * Math.PI * 2,
                    Math.random() * Math.PI * 2
                  )
                );

                tempScale.set(1, 1, 1);

                tempMatrix.compose(tempPosition, tempQuaternion, tempScale);
                visibleMeshGroup.setMatrixAt(localIndex, tempMatrix);
                raycastMeshGroup.setMatrixAt(localIndex, tempMatrix);

                if (instanceData[originalIndex]) {
                  instanceData[originalIndex].visibleMeshGroup =
                    visibleMeshGroup;
                  instanceData[originalIndex].raycastMeshGroup =
                    raycastMeshGroup;
                  instanceData[originalIndex].localInstanceId = localIndex;
                }
              });

              visibleMeshGroup.instanceMatrix.needsUpdate = true;
              raycastMeshGroup.instanceMatrix.needsUpdate = true;
            })
            .catch((error) => {
              texturesLoaded++;
              updateLoaderProgress(texturesLoaded, totalTexturesToLoad);
              console.error(`Failed to load texture ${imageUrl}:`, error);
            });

          loadPromises.push(loadPromise);
        }

        await Promise.allSettled(loadPromises);
        checkLoadingComplete();
      }

      function updateLoaderProgress(loaded, total) {
        if (loaderElement) {
          const percentage =
            total > 0 ? Math.round((loaded / total) * 100) : 100;
          loaderElement.textContent = `로딩 중... ${loaded}/${total} (${percentage}%)`;
        }
      }

      function checkLoadingComplete() {
        if (loaderElement && loaderElement.style.display !== "none") {
          const allTexturesProcessed = texturesLoaded >= totalTexturesToLoad;
          if (allTexturesProcessed) {
            loaderElement.style.display = "none";
            console.log("All textures processed, setup complete.");
          }
        }
      }

      function setupEventListeners() {
        window.addEventListener("resize", onWindowResize);

        // Use pointer events for unified mouse/touch handling where possible
        document.addEventListener(
          "pointermove",
          throttle(onPointerMove, CONFIG.ANIMATION.THROTTLE)
        );
        document.addEventListener("pointerdown", onPointerDown); // Handles both click and tap start

        // Specific touch events for finer control if needed (e.g., preventing scroll while dragging)
        // document.addEventListener('touchstart', onTouchStart, { passive: false });
        // document.addEventListener('touchmove', onTouchMove, { passive: false }); // Already handled by pointermove + OrbitControls

        bgColorPicker.addEventListener("input", onBgColorChange);
        visitSiteButton.addEventListener("click", onVisitSiteClick);

        // Prevent controls from interfering with OrbitControls drag
        controlsElement.addEventListener("pointerdown", (e) =>
          e.stopPropagation()
        );
        controlsElement.addEventListener("touchstart", (e) =>
          e.stopPropagation()
        ); // For safety on older devices
      }

      function throttle(func, limit) {
        let inThrottle;
        let lastExecutionTime = 0;
        return function (...args) {
          const now = Date.now();
          if (!inThrottle) {
            // Execute immediately if not throttled
            func.apply(this, args);
            lastExecutionTime = now;
            inThrottle = true;
            setTimeout(() => {
              inThrottle = false;
              // Optional: Check if another event happened during throttle period and execute it now
              // This makes it feel slightly more responsive on the last event
            }, limit);
          }
          // else { // Optionally queue or track the last event during throttle }
        };
      }

      function onWindowResize() {
        camera.aspect = window.innerWidth / window.innerHeight;
        camera.updateProjectionMatrix();
        renderer.setSize(window.innerWidth, window.innerHeight);
        renderer.setPixelRatio(Math.min(window.devicePixelRatio, 2));
      }

      // Combined pointer move handler
      function onPointerMove(event) {
        // Update pointer coordinates relative to the canvas
        pointer.x = (event.clientX / window.innerWidth) * 2 - 1;
        pointer.y = -(event.clientY / window.innerHeight) * 2 + 1;

        // Handle hover effect (raycasting)
        handleIntersections(false); // Pass false: don't trigger selection
      }

      // Combined pointer down handler (click/tap start)
      function onPointerDown(event) {
        // Ignore clicks/taps on the UI controls
        if (controlsElement.contains(event.target)) return;

        // Update pointer coordinates (might be redundant if pointermove fired just before, but safe)
        pointer.x = (event.clientX / window.innerWidth) * 2 - 1;
        pointer.y = -(event.clientY / window.innerHeight) * 2 + 1;

        // Handle selection (raycasting and triggering selection logic)
        handleIntersections(true); // Pass true: trigger selection
      }

      function onBgColorChange(event) {
        const newColor = event.target.value;
        document.body.style.backgroundColor = newColor;
        const threeColor = new THREE.Color(newColor);
        if (scene.fog) {
          scene.fog.color.set(threeColor);
        }
        renderer.setClearColor(threeColor);
      }

      function onVisitSiteClick() {
        const url = visitSiteButton.getAttribute("data-url");
        if (url && url !== "https://mayi2d.shop/") {
          // Avoid opening base URL if it's a placeholder
          window.open(url, "_blank");
        } else if (url) {
          console.log("Visit site clicked for base URL:", url);
        }
      }

      function handleIntersections(isSelectionAttempt) {
        raycaster.setFromCamera(pointer, camera);
        const intersects = raycaster.intersectObjects(raycastMeshes);

        let newIntersectedInfo = null;

        if (intersects.length > 0) {
          const intersect = intersects[0];
          const raycastMeshGroup = intersect.object;
          const localInstanceId = intersect.instanceId;

          const originalIndex = instanceData.findIndex(
            (data) =>
              data &&
              data.raycastMeshGroup === raycastMeshGroup &&
              data.localInstanceId === localInstanceId
          );

          if (originalIndex !== -1) {
            const visibleMeshGroup =
              instanceData[originalIndex].visibleMeshGroup;
            if (visibleMeshGroup) {
              newIntersectedInfo = {
                originalIndex,
                meshGroup: visibleMeshGroup,
                localInstanceId,
              };
            }
          }
        }

        // --- Handle Hover Effect (Scale and Color Change) ---
        if (
          INTERSECTED_INFO?.originalIndex !== newIntersectedInfo?.originalIndex
        ) {
          // Reset scale and color on previously hovered item
          if (INTERSECTED_INFO) {
            const oldData = instanceData[INTERSECTED_INFO.originalIndex];
            if (oldData?.visibleMeshGroup && oldData.localInstanceId !== -1) {
              try {
                // Reset Scale
                INTERSECTED_INFO.meshGroup.getMatrixAt(
                  INTERSECTED_INFO.localInstanceId,
                  tempMatrix
                );
                tempMatrix.decompose(tempPosition, tempQuaternion, tempScale);
                if (!tempScale.equals(normalScaleVec)) {
                  tempScale.copy(normalScaleVec);
                  tempMatrix.compose(tempPosition, tempQuaternion, tempScale);
                  INTERSECTED_INFO.meshGroup.setMatrixAt(
                    INTERSECTED_INFO.localInstanceId,
                    tempMatrix
                  );
                  INTERSECTED_INFO.meshGroup.instanceMatrix.needsUpdate = true;
                }

                // Reset Color
                if (INTERSECTED_INFO.meshGroup.instanceColor) {
                  INTERSECTED_INFO.meshGroup.setColorAt(
                    INTERSECTED_INFO.localInstanceId,
                    normalColor
                  );
                  INTERSECTED_INFO.meshGroup.instanceColor.needsUpdate = true;
                }
              } catch (e) {
                console.error(
                  "Error resetting scale/color:",
                  e,
                  INTERSECTED_INFO
                );
              }
            }
          }

          // Apply scale and color to newly hovered item
          if (newIntersectedInfo) {
            const newData = instanceData[newIntersectedInfo.originalIndex];
            if (newData?.visibleMeshGroup && newData.localInstanceId !== -1) {
              try {
                // Apply Scale
                newIntersectedInfo.meshGroup.getMatrixAt(
                  newIntersectedInfo.localInstanceId,
                  tempMatrix
                );
                tempMatrix.decompose(tempPosition, tempQuaternion, tempScale);
                if (tempScale.equals(normalScaleVec)) {
                  tempScale.copy(hoverScaleVec);
                  tempMatrix.compose(tempPosition, tempQuaternion, tempScale);
                  newIntersectedInfo.meshGroup.setMatrixAt(
                    newIntersectedInfo.localInstanceId,
                    tempMatrix
                  );
                  newIntersectedInfo.meshGroup.instanceMatrix.needsUpdate = true;
                }

                // Apply Hover Color
                if (newIntersectedInfo.meshGroup.instanceColor) {
                  newIntersectedInfo.meshGroup.setColorAt(
                    newIntersectedInfo.localInstanceId,
                    hoverColor
                  );
                  newIntersectedInfo.meshGroup.instanceColor.needsUpdate = true;
                }
              } catch (e) {
                console.error(
                  "Error applying scale/color:",
                  e,
                  newIntersectedInfo
                );
              }
            }
          }

          INTERSECTED_INFO = newIntersectedInfo;
        }

        // --- Handle Selection ---
        if (isSelectionAttempt && newIntersectedInfo) {
          const data = instanceData[newIntersectedInfo.originalIndex];
          if (data) {
            selectedItemImage.src = data.imageUrl;
            selectedItemImage.alt = "Selected product";
            visitSiteButton.setAttribute("data-url", data.purchaseUrl);
            selectedItemPanel.style.display = "block";
            visitSiteButton.disabled =
              !data.purchaseUrl || data.purchaseUrl === "https://mayi2d.shop/";
          }
        } else if (!isSelectionAttempt && !newIntersectedInfo) {
          if (!selectedItemImage.src) {
            selectedItemPanel.style.display = "none";
          }
        }
      }

      function animate() {
        requestAnimationFrame(animate);
        const delta = clock.getDelta();
        const elapsedTime = clock.getElapsedTime();

        let matrixNeedsUpdate = false;

        // --- Update Instance Transforms ---
        for (let i = 0; i < instanceData.length; i++) {
          const data = instanceData[i];
          if (
            data &&
            data.visibleMeshGroup &&
            data.raycastMeshGroup &&
            data.localInstanceId !== -1
          ) {
            try {
              // 1. Get current transform data
              data.visibleMeshGroup.getMatrixAt(
                data.localInstanceId,
                tempMatrix
              );
              tempMatrix.decompose(tempPosition, tempQuaternion, tempScale);

              // 2. Apply subtle floating effect
              const oscillationFactor =
                Math.sin(elapsedTime * 0.2 + i * 0.1) * 0.02;
              tempPosition.y += oscillationFactor;

              // 3. Apply gentle rotation
              const currentEuler = new THREE.Euler().setFromQuaternion(
                tempQuaternion,
                "XYZ"
              );
              currentEuler.x += data.rotationSpeed.x * delta;
              currentEuler.y += data.rotationSpeed.y * delta;
              currentEuler.z += data.rotationSpeed.z * delta;
              tempQuaternion.setFromEuler(currentEuler);

              // 4. Recompose the matrix
              tempMatrix.compose(tempPosition, tempQuaternion, tempScale);

              // 5. Set the updated matrix back
              data.visibleMeshGroup.setMatrixAt(
                data.localInstanceId,
                tempMatrix
              );
              data.raycastMeshGroup.setMatrixAt(
                data.localInstanceId,
                tempMatrix
              );

              matrixNeedsUpdate = true;
            } catch (error) {
              console.error(
                `Error animating instance originalIndex ${i}, localId ${data.localInstanceId}:`,
                error,
                data
              );
            }
          }
        }

        // --- Update Particles ---
        if (particleSystem) {
          particleSystem.rotation.y += delta * 0.015;
          particleSystem.rotation.x += delta * 0.005;
        }

        // --- Update needsUpdate flag for relevant mesh groups ---
        if (matrixNeedsUpdate) {
          instancedMeshes.forEach((mesh) => {
            mesh.instanceMatrix.needsUpdate = true;
          });
          raycastMeshes.forEach((mesh) => {
            mesh.instanceMatrix.needsUpdate = true;
          });
        }

        // --- Update Lights ---
        pointLights.forEach((light) => {
          light.userData.angle += light.userData.speed * delta;
          const x = Math.cos(light.userData.angle) * light.userData.radius;
          const y =
            Math.sin(elapsedTime * light.userData.speed * 0.5) * 5 +
            light.userData.yOffset;
          const z = Math.sin(light.userData.angle) * light.userData.radius;
          light.position.set(x, y, z);
        });

        // --- Update Controls & Render ---
        if (controls) {
          controls.update();
        }

        if (renderer && scene && camera) {
          renderer.render(scene, camera);
        }
      }

      // Optimized Texture Loader with Caching and Error Handling
      async function loadTexture(loader, url) {
        if (!url)
          return Promise.reject(new Error("Texture URL is empty or invalid"));

        if (textureCache.has(url)) {
          return textureCache.get(url);
        }

        const promise = new Promise((resolve, reject) => {
          loader.load(
            url,
            (texture) => {
              texture.colorSpace = THREE.SRGBColorSpace;
              texture.minFilter = THREE.LinearFilter;
              texture.magFilter = THREE.LinearFilter;
              texture.needsUpdate = true;
              resolve(texture);
            },
            undefined,
            (errorEvent) => {
              console.error(`Error loading texture: ${url}`, errorEvent);
              textureCache.delete(url);
              reject(new Error(`Failed to load texture ${url}`));
            }
          );
        });

        textureCache.set(url, promise);
        return promise;
      }

      function showError(message) {
        if (loaderElement) {
          loaderElement.textContent = message;
          loaderElement.style.color = "red";
          loaderElement.style.display = "block";
        } else {
          const errorDiv = document.createElement("div");
          errorDiv.style.cssText = `
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(200, 0, 0, 0.8);
            color: white;
            padding: 20px;
            border-radius: 5px;
            z-index: 1000;
            text-align: center;
          `;
          errorDiv.textContent = message;
          document.body.appendChild(errorDiv);
        }
      }
    </script>
  </body>
</html>
